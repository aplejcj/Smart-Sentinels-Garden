import "pe"

rule Suspicious_Activity_Scoring
{
    meta:
        description = "Detects a combination of suspicious activities based on a scoring system."
        author = "IronForest Project (Advanced)"
        threat_level = 7
        
    strings:
        // Process Control (3 points)
        $p1 = "CreateRemoteThread"
        $p2 = "WriteProcessMemory"
        $p3 = "ResumeThread"

        // Network Activity (2 points)
        $n1 = "HttpSendRequestA"
        $n2 = "InternetReadFile"
        $n3 = "gethostbyname"

        // Keystroke Logging (5 points)
        $k1 = "SetWindowsHookExA"
        $k2 = "GetKeyboardState"

    condition:
        // Must be a Windows PE file
        uint16(0) == 0x5A4D and 
        (
            // Alert if total risk score is 7 or more
            (1 of ($p*)) * 3 + (1 of ($n*)) * 2 + (1 of ($k*)) * 5 >= 7
        )
}

rule Highly_Suspicious_UPX_Packed_File
{
    meta:
        description = "Detects files packed with UPX that also exhibit other suspicious characteristics."
        author = "IronForest Project (Advanced)"
        threat_level = 5

    strings:
        $upx_sig1 = "UPX0"
        $upx_sig2 = "UPX1"
        
    condition:
        uint16(0) == 0x5A4D and (1 of ($upx_sig*)) and
        (
            // Must have at least one other suspicious indicator
            pe.entropy > 7.5 or
            pe.number_of_resources == 0
        )
}

rule Anti_Debug_Techniques
{
    meta:
        description = "Detects common anti-debugging techniques used by malware."
        author = "IronForest Project (Advanced)"
        threat_level = 4

    strings:
        $s1 = "IsDebuggerPresent"
        $s2 = "CheckRemoteDebuggerPresent"
        $s3 = "OutputDebugStringA"

    condition:
        uint16(0) == 0x5A4D and 2 of them
}